
<!DOCTYPE html>

<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Поиск границ Агрегатов &#8212; System Architecture</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" type="text/css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/translations.js"></script>
    <link rel="index" title="Алфавитный указатель" href="../../../../../genindex.html" />
    <link rel="search" title="Поиск" href="../../../../../search.html" />
    <link rel="next" title="Как сохранить Агрегат в БД не разрушая инкапсуляции?" href="aggregate-encapsulation.html" />
    <link rel="prev" title="Domain Layer" href="index.html" />
    
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />



    
        
            <link rel="canonical" href="https://dckms.github.io/system-architecture/emacsway/it/ddd/grade/domain/aggregate-boundaries.html" />
        
    

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="index.html" title="Previous document">Domain Layer</a>
        </li>
        <li>
          <a href="aggregate-encapsulation.html" title="Next document">Как сохранить Агрегат в БД не разрушая инкапсуляции?</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
    
  <section id="emacsway-golang-aggregate">
<span id="id1"></span><h1><a class="toc-backref" href="#id14" role="doc-backlink">Поиск границ Агрегатов</a><a class="headerlink" href="#emacsway-golang-aggregate" title="Permalink to this heading">¶</a></h1>
<p><em>Автор раздела: Ivan Zakrevsky</em></p>
<nav class="contents" id="id2">
<p class="topic-title">Содержание</p>
<ul class="simple">
<li><p><a class="reference internal" href="#emacsway-golang-aggregate" id="id14">Поиск границ Агрегатов</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id15">Бизнес-требования</a></p></li>
<li><p><a class="reference internal" href="#strong-consistency-rdbms" id="id16">Strong Consistency (RDBMS)</a></p></li>
<li><p><a class="reference internal" href="#eventual-consistency" id="id17">Eventual Consistency</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id18">Первоначальная модель</a></p>
<ul>
<li><p><a class="reference internal" href="#id5" id="id19">Упрощенная реализация первоначальной модели</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id20">Реализация требований</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id21">Проблемы данной модели</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id22">Вероятность утраты согласованности</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id23">Уникальность артефакта</a></p></li>
<li><p><a class="reference internal" href="#endorsement" id="id24">Преобразование Endorsement в Сущность</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id25">Достижение согласованности</a></p>
<ul>
<li><p><a class="reference internal" href="#data-context-and-interaction-dci" id="id26">Data, context, and interaction (DCI)</a></p></li>
<li><p><a class="reference internal" href="#process-manager-pattern" id="id27">Process Manager Pattern</a></p></li>
<li><p><a class="reference internal" href="#pessimistic-offline-lock" id="id28">Pessimistic Offline Lock</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id29">Резервирование</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id12" id="id30">Упрощенная реализация итоговой модели</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#missing-chapter" id="id31">Missing chapter</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="id3">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Бизнес-требования</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h2>
<p>Бизнес-требования к Reference Application описаны в разделе &quot;<a class="reference external" href="https://github.com/ru-arc/charter/blob/main/charter.md#46-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D0%BA%D0%B2%D0%B0%D0%BB%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D0%BE%D0%B9-%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8-%D1%87%D0%BB%D0%B5%D0%BD%D0%BE%D0%B2-%D0%BE%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8">4.6. Система квалификационной классификации членов Организации</a>&quot; Устава региональной общественной организации &quot;Объединение ИТ-Архитекторов&quot;.</p>
<p>Выделим основные из них:</p>
<ol class="arabic simple">
<li><p>Каждый член Организации может отдать 20 рекомендаций (признаний) в год в пользу других членов.</p></li>
<li><p>Одна рекомендация от члена Организации претендуемого (или более высокого) квалификационного класса равноценна двум рекомендациям от членов Организации текущего квалификационного класса (излишки не переносятся).</p></li>
<li><p>Рекомендации от членов Организации более низкого квалификационного класса не допускаются.</p></li>
<li><p>Допускается одна рекомендация рекомендующего за один конкретный артефакт рекомендуемого.</p></li>
<li><p>Требуемые количества рекомендаций по квалификационным классам:</p>
<ol class="arabic simple">
<li><p>Эксперт - 20 рекомендаций Экспертов или 40 рекомендаций Кандидатов в эксперты;</p></li>
<li><p>Кандидат в эксперты - 10 рекомендаций Кандидатов в эксперты или 20 рекомендаций 1-го класса;</p></li>
<li><p>1 класс - 7 рекомендаций 1-го класса или 14 рекомендаций 2-го класса;</p></li>
<li><p>2 класс - 5 рекомендаций 2-го класса или 10 рекомендаций 3-го класса;</p></li>
<li><p>3 класс - 3 рекомендации 3-го класса или 6 рекомендаций без класса;</p></li>
<li><p>без класса - по умолчанию.</p></li>
</ol>
</li>
</ol>
<p>Остальные требования в настоящий момент рассмотрения пока не сильно релевантны.</p>
</section>
<section id="strong-consistency-rdbms">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Strong Consistency (RDBMS)</a><a class="headerlink" href="#strong-consistency-rdbms" title="Permalink to this heading">¶</a></h2>
<p>Этот вариант реализации хорошо был расcмотрен в статье &quot;<a class="reference external" href="https://enterprisecraftsmanship.com/posts/modeling-relationships-in-ddd-way/">Modeling Relationships in a DDD Way</a>&quot; by Vladimir Khorikov, поэтому подробно рассматривать мы его не будем.
Приведу только заключительный фрагмент его статьи:</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://stackoverflow.com/questions/24921227/save-and-load-objects-without-breaking-encapsulation">Example from Stackoverflow</a></span><a class="headerlink" href="#id13" title="Постоянная ссылка на код">¶</a></div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Student</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Email</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">IList</span><span class="p">&lt;</span><span class="n">StudentInstructor</span><span class="p">&gt;</span><span class="w"> </span><span class="n">_studentInstructors</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">Instructor</span><span class="p">&gt;</span><span class="w"> </span><span class="n">Instructors</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">_studentInstructors</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Instructor</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">DateAdded</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">internal</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">AddInstructor</span><span class="p">(</span><span class="n">StudentInstructor</span><span class="w"> </span><span class="n">instructor</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">_studentInstructors</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">instructor</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Instructor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">IList</span><span class="p">&lt;</span><span class="n">StudentInstructor</span><span class="p">&gt;</span><span class="w"> </span><span class="n">_studentInstructors</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">Student</span><span class="p">&gt;</span><span class="w"> </span><span class="n">Students</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">_studentInstructors</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Student</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">DateAdded</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">AddStudent</span><span class="p">(</span><span class="n">Student</span><span class="w"> </span><span class="n">student</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">studentInstructor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StudentInstructor</span><span class="p">(</span><span class="n">student</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">_studentInstructors</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">studentInstructor</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">student</span><span class="p">.</span><span class="n">AddInstructor</span><span class="p">(</span><span class="n">studentInstructor</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">StudentInstructor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Entity</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Student</span><span class="w"> </span><span class="n">Student</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Instructor</span><span class="w"> </span><span class="n">Instructor</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">DateAdded</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">StudentInstructor</span><span class="p">(</span><span class="n">Student</span><span class="w"> </span><span class="n">student</span><span class="p">,</span><span class="w"> </span><span class="n">Instructor</span><span class="w"> </span><span class="n">instructor</span><span class="p">,</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">dateAdded</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Student</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">student</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Instructor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">instructor</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">DateAdded</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dateAdded</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</section>
<section id="eventual-consistency">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">Eventual Consistency</a><a class="headerlink" href="#eventual-consistency" title="Permalink to this heading">¶</a></h2>
<section id="id4">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Первоначальная модель</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>Хотя предполагается использование RDBMS, но была предпринята попытка найти такие контуры Агрегатов, которые без существенной переработки могли бы функционировать и в условиях отсутствия транзакционной согласованности.</p>
<p>Самый первый вариант модели практически полностью воспроизводил структуру (online) excel-таблиц, использовавшихся на тот момент.
Упрощенная реализация модели выглядела примерно так:</p>
<section id="id5">
<h4><a class="toc-backref" href="#id19" role="doc-backlink">Упрощенная реализация первоначальной модели</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h4>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">grade_1</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;errors&quot;</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;time&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">MemberId</span><span class="w"> </span><span class="kt">uint64</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Grade</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">AvailableEndorsementCount</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ReceivedEndorsementCount</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">EndorsementId</span><span class="w"> </span><span class="kt">uint64</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ArtifactDescription</span><span class="w"> </span><span class="kt">string</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Weight</span><span class="w"> </span><span class="kt">uint8</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">PeerWeight</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nx">HigherWeight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">Expert</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Candidate</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade1</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade2</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade3</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">WithoutGrade</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Specialist</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">                       </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">grade</span><span class="w">                    </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="nx">ReceivedEndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">assignments</span><span class="w">              </span><span class="p">[]</span><span class="nx">Assignment</span><span class="w"></span>
<span class="w">    </span><span class="nx">version</span><span class="w">                  </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">                </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">GetId</span><span class="p">()</span><span class="w"> </span><span class="nx">MemberId</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">GetGrade</span><span class="p">()</span><span class="w"> </span><span class="nx">Grade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">GetVersion</span><span class="p">()</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">IncreaseReceivedEndorsementCount</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">Weight</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">ReceivedEndorsementCount</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">WithoutGrade</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Grade3</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Grade3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Grade2</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Grade2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Grade1</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Grade1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Candidate</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Candidate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Expert</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsementCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="nx">Grade</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">assignments</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">assignments</span><span class="p">,</span><span class="w"> </span><span class="nx">Assignment</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">g</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">IncreaseVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Assignment</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistId</span><span class="w">        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistVersion</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">assignedGrade</span><span class="w">       </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">           </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Endorser</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">                        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">grade</span><span class="w">                     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="nx">AvailableEndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">version</span><span class="w">                   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">                 </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">Endorse</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">Specialist</span><span class="p">,</span><span class="w"> </span><span class="nx">aDesc</span><span class="w"> </span><span class="nx">ArtifactDescription</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">Endorsement</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">{},</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;it is allowed to endorse only members with equal or lower grade&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">{},</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;you have reached the limit of available recommendations this year&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">GetId</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">{},</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;endorser can&#39;t endorse himself&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">grade</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">GetVersion</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="nx">aDesc</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">DecreaseAvailableEndorsementCount</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;no endorsement is available&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">IncreaseVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Endorsement</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserId</span><span class="w">        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserGrade</span><span class="w">     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserVersion</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistId</span><span class="w">        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistGrade</span><span class="w">     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistVersion</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">artifactDescription</span><span class="w"> </span><span class="nx">ArtifactDescription</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">           </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Метод <code class="docutils literal notranslate"><span class="pre">Endorser.Endorse(Specialist,</span> <span class="pre">ArtifactDescription,</span> <span class="pre">time.Time)</span></code> является фабричным методом Агрегата <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code>.
При сохранении Агрегата <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code> в Хранилище, из него извлекаются Доменные События, и отправляются подписчикам через некий механизм доставки.
Мы предполагаем, что они могут быть обработаны как синхронно в той же транзакции (Mediator/Observer Design Pattern), так и асинхронно в другой транзакции (<a class="reference external" href="https://www.enterpriseintegrationpatterns.com/MessageBroker.html">Message Broker</a>).</p>
<p>На Доменное Событие <code class="docutils literal notranslate"><span class="pre">EndorsementCreated</span></code> подписаны:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Endorser</span></code>, у которого вызывается метод <code class="docutils literal notranslate"><span class="pre">Endorser.DecreaseAvailableEndorsementCount()</span></code> для вычитания использованной рекомендации из счетчика доступных в этом году рекомендаций;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Endorse</span></code>, у которого вызывается метод <code class="docutils literal notranslate"><span class="pre">Specialist.IncreaseReceivedEndorsementCount(Weight)</span></code> с указанием веса рекомендации, зависящего от отношения квалификационного класса рекомендующего к квалификационному классу рекомендуемого.</p></li>
</ol>
<p>Обратите внимание, <code class="docutils literal notranslate"><span class="pre">Assignment</span></code>, как и <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code>, имеет значение для бизнес-правил, и он не может быть усечен снэпшотом event sourced log.
Например, он может устанавливать правила минимального, либо максимального периода времени между присваиваниями классности, например, не чаще одного раза в полгода.
Или, например, требовать подтверждения текущей классности в случае отсутствия присваиваний в течении года.
Поэтому, он выполнен в виде самостоятельного Объекта-Значения.
В ином случае он мог бы быть перемещен в ReadModel.</p>
<p><code class="docutils literal notranslate"><span class="pre">Endorsement</span></code>, в свою очередь, отвечает за то, чтобы <code class="docutils literal notranslate"><span class="pre">Endorser</span></code> не смог порекомендовать один и тот же <code class="docutils literal notranslate"><span class="pre">Artifact</span></code> одного и того же <code class="docutils literal notranslate"><span class="pre">Specialist</span></code> дважды.</p>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id20" role="doc-backlink">Реализация требований</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<p>Пройдемся по требованиям:</p>
<dl class="simple">
<dt>Каждый член Организации может отдать 20 рекомендаций (признаний) в год в пользу других членов.</dt><dd><p>Это требование реализуется счетчиком <code class="docutils literal notranslate"><span class="pre">Endorser.availableEndorsementCount</span></code> и инвариантом <code class="docutils literal notranslate"><span class="pre">Объекта-Значения</span> <span class="pre">AvailableEndorsementCount</span></code>, который не может превышать установленное ограничение.</p>
</dd>
<dt>Одна рекомендация от члена Организации претендуемого (или более высокого) квалификационного класса равноценна двум рекомендациям от членов Организации текущего квалификационного класса (излишки не переносятся).</dt><dd><p>Это требование реализуется обработчиком Доменного События <code class="docutils literal notranslate"><span class="pre">EndorsementCreated</span></code> перед вызовом метода <code class="docutils literal notranslate"><span class="pre">Specialist.IncreaseReceivedEndorsementCount(Weight)</span></code>.</p>
</dd>
<dt>Рекомендации от членов Организации более низкого квалификационного класса не допускаются.</dt><dd><p>Реализуется фабричным методом <code class="docutils literal notranslate"><span class="pre">Endorser.Endorse(...)</span></code>.</p>
</dd>
<dt>Допускается одна рекомендация рекомендующего за один конкретный артефакт рекомендуемого.</dt><dd><p>Это требование обсудим отдельно.</p>
</dd>
<dt>Требуемые количества рекомендаций по квалификационным классам...</dt><dd><p>Реализуется фабричным методом <code class="docutils literal notranslate"><span class="pre">Endorser.Endorse(...)</span></code>.</p>
</dd>
</dl>
</section>
<section id="id7">
<h4><a class="toc-backref" href="#id21" role="doc-backlink">Проблемы данной модели</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h4>
<p>В существующей модели прослеживается ряд проблем. Рассмотрим их по порядку.</p>
<section id="id8">
<h5><a class="toc-backref" href="#id22" role="doc-backlink">Вероятность утраты согласованности</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h5>
<p>Давайте представим, что <code class="docutils literal notranslate"><span class="pre">endorserA</span></code> 2-го класса дает рекомендацию в пользу <code class="docutils literal notranslate"><span class="pre">specialistA</span></code> 2-го класса, у которого уже существует 13 рекомендаций, т.е. для присвоения нового квалификационного класса не хватает всего одной рекомендации.
В период времени с момента проверки инварианта методом <code class="docutils literal notranslate"><span class="pre">Endorser.Endorse(...)</span></code> и до декрементирования счетчика доступных рекомендаций рекомендующего методом <code class="docutils literal notranslate"><span class="pre">Endorser.DecreaseAvailableEndorsementCount()</span></code>, а также до вызова метода <code class="docutils literal notranslate"><span class="pre">Specialist.IncreaseReceivedEndorsementCount(Weight)</span></code>, другой участник <code class="docutils literal notranslate"><span class="pre">endorserB</span></code> 2-го класса может также успеть дать рекомендацию в пользу <code class="docutils literal notranslate"><span class="pre">specialistA</span></code>.</p>
<p>В результате рекомендация <code class="docutils literal notranslate"><span class="pre">endorserB</span></code> будет зачтена в пользу <code class="docutils literal notranslate"><span class="pre">specialistA</span></code> уже фактически 1-го класса, что нарушает требование о запрете на рекомендацию участников более высокого квалификационного класса.</p>
<p>Для упреждения такой ситуации достаточно наложить покрывающий (композитный) уникальный индекс на поля <code class="docutils literal notranslate"><span class="pre">Endorsement.specialistId</span></code> и <code class="docutils literal notranslate"><span class="pre">Endorsement.specialistVersion</span></code>.</p>
<p>Или рассмотрим другую ситуацию.
Участник <code class="docutils literal notranslate"><span class="pre">endorserA</span></code>, у которого оставалась всего одна доступная рекомендация в текущем году, дает рекомендацию в пользу <code class="docutils literal notranslate"><span class="pre">specialistA</span></code>,
но произошла техническая задержка доставки сообщения <code class="docutils literal notranslate"><span class="pre">EndorsementCreated</span></code> рекомендующему по техническим причинам, например, очередь &quot;встала&quot; (или подписчик затупил, чек-поинт в БД запустился, сеть упала...), и тогда рекомендующий может успеть раздать рекомендаций больше, чем располагает.
Упреждается такая ситуация таким же образом - покрывающим уникальным индексом на поля <code class="docutils literal notranslate"><span class="pre">Endorsement.endorserId</span></code> и <code class="docutils literal notranslate"><span class="pre">Endorsement.endorserGrade</span></code>.</p>
<p>Но это выдвигает новый вопрос - каким образом партиционировать таблицу <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code>, чтобы реализовать оба уникальных индекса?
Кто хоть раз занимался партиционированием, тот знает, что уникальный индекс возможен только в пределах партиции.
Можно, конечно, партиционировать <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code> по автоинкрементальному первичному ключу (или по дате создания), но тут самое время перейти к следующему требованию, которое гласит: &quot;Допускается одна рекомендация рекомендующего за один конкретный артефакт рекомендуемого&quot;.</p>
</section>
<section id="id9">
<h5><a class="toc-backref" href="#id23" role="doc-backlink">Уникальность артефакта</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h5>
<p>Суть в том, что дубликаты описаний артефактов могут быть нечеткими.
Требуется вводить пре-модерацию рекомендаций.
Но это значит, что оптимистическая блокировка с помощью уникального индекса может длиться часами и днями.
Вряд ли пользователи системы будут в восторге от этого.</p>
<p>А что если выделить <code class="docutils literal notranslate"><span class="pre">Endorsement.artifactDescription</span></code> в отдельный Агрегат и сделать пре-модерацию для него?
Кажется, это предотвратит длительные блокировки по уже одобренным артефактам, а рекомендация неодобренных артефактов в принципе невозможна.
Более того, артефакты можно категоризировать, и тогда система сможет информировать не только о квалификационной классности члена Организации, но и об областях знаний его экспертности.</p>
<p>Вносим правки:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Endorsement</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserId</span><span class="w">        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserGrade</span><span class="w">     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserVersion</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistId</span><span class="w">        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistGrade</span><span class="w">     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistVersion</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">artifactId</span><span class="w">          </span><span class="nx">ArtifactId</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">           </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Artifact</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">            </span><span class="nx">ArtifactId</span><span class="w"></span>
<span class="w">    </span><span class="nx">status</span><span class="w">        </span><span class="nx">ArtifactStatus</span><span class="w"></span>
<span class="w">    </span><span class="nx">description</span><span class="w">   </span><span class="nx">ArtifactDescription</span><span class="w"></span>
<span class="w">    </span><span class="nx">competenceIds</span><span class="w"> </span><span class="p">[]</span><span class="nx">CompetenceId</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">     </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Competence</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">        </span><span class="nx">CompetenceId</span><span class="w"></span>
<span class="w">    </span><span class="nx">name</span><span class="w">      </span><span class="nx">CompetenceName</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Задача упрощается.
В момент создания Агрегата <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code> мы можем удостовериться, что такой артефакт такого рекомендуемого еще пока не был рекомендован таким рекомендующим, с помощью стратегии-валидатора, передаваемой аргументом в фабричный метод, ответственный за создание этого Агрегата.</p>
<p>Но вот в чем дело.
После выделения артефакта в отдельный Агрегат, нам корневой доступ к Агрегату <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code> особо-то и не нужен.
Это значит, что его можно преобразовать в Сущность.</p>
</section>
<section id="endorsement">
<h5><a class="toc-backref" href="#id24" role="doc-backlink">Преобразование Endorsement в Сущность</a><a class="headerlink" href="#endorsement" title="Permalink to this heading">¶</a></h5>
<p>С точки зрения <a class="reference external" href="https://enterprisecraftsmanship.com/posts/domain-model-purity-completeness/">DDD Trilemma</a>, учитывая относительно небольшое количество возможных рекомендаций в процессе жизни Агрегата <code class="docutils literal notranslate"><span class="pre">Specialist</span></code>, имеет смысл отдать предпочтение в пользу &quot;Domain model purity&quot; и &quot;Domain model completeness&quot;.</p>
<p>Вопрос в том, в каком именно Агрегате разместить Сущность <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code>?
Ответ на этот вопрос подскажет нам, по какому ключу лучше партиционировать таблицу <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code>.
Сейчас становится уже очевидно, что партиционирование по автоинкрементальному первичному ключу (или по дате создания) будет приводить к просмотру всех партиций, что нас не устраивает.</p>
<p>У кого хранится в реальном мире наградной лист, почетная грамота, сертификат и т.д. - у награждаемого или у награждающего?
Для кого он имеет ценность?</p>
<p>Это наводит на мысль о том, что Сущность <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code> должна принадлежать Агрегату <code class="docutils literal notranslate"><span class="pre">Specialist</span></code>.
Что подтвержается также ответом на вопрос о том, должен ли рекомендующий, т.е. Агрегат <code class="docutils literal notranslate"><span class="pre">Endorser</span></code>, хранить рекомендации удаленных из системы рекомендуемых?
Вроде бы рекомендации должны удаляться вместе с рекомендуемым (это отвечает и на вопрос о том, по какому ключу партиционировать таблицу <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code>).
А вот если из системы удаляется рекомендующий, то его рекомендации продолжают иметь значение как способ подтверждения достоверности квалификационной классности рекомендуемого.
Иными словами, квалификационная классность рекомендуемого является <a class="reference external" href="https://ru.wikipedia.org/wiki/%D0%A1%D0%B2%D1%91%D1%80%D1%82%D0%BA%D0%B0_%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0">сверткой (left fold)</a> этих рекомендаций, по-другому говоря - их проекцией.</p>
<p>Таким образом, между рекомендуемым и рекомендациями образуется строгая согласованность.
Все, что теперь требуется Агрегату <code class="docutils literal notranslate"><span class="pre">Specialist</span></code> для того, чтобы установить возможность создания рекомендации - это квалификационный класс рекомендующего и достоверность того, что он пока еще не исчерпал доступные ему рекомендации.</p>
<p>Но это так же значит, что мы не можем создать покрывающий уникальный индекс на поля <code class="docutils literal notranslate"><span class="pre">Endorsement.endorserId</span></code> и <code class="docutils literal notranslate"><span class="pre">Endorsement.endorserGrade</span></code>.</p>
<p>Иными словами, существует незначительная вероятность того, что <code class="docutils literal notranslate"><span class="pre">Endorser</span></code> успеет раздать рекомендаций больше, чем ему доступно.
Существует несколько способов решить эту проблему.</p>
</section>
<section id="id10">
<h5><a class="toc-backref" href="#id25" role="doc-backlink">Достижение согласованности</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h5>
<section id="data-context-and-interaction-dci">
<h6><a class="toc-backref" href="#id26" role="doc-backlink">Data, context, and interaction (DCI)</a><a class="headerlink" href="#data-context-and-interaction-dci" title="Permalink to this heading">¶</a></h6>
<p>Первый из них - это &quot;<a class="reference external" href="https://en.m.wikipedia.org/wiki/Data,_context_and_interaction">Data, context, and interaction (DCI)</a>&quot;.
Подробно он описан в главе &quot;Chapter 9. Coding it Up: The DCI Architecture&quot; книги &quot;Lean Architecture: for Agile Software Development&quot; 1st edition by James O. Coplien, Gertrud Bjørnvig.
Можно посмотреть на <a class="reference external" href="https://github.com/agiledragon/transfer-money-go">примере реализации перевода денежных средств</a> с одного счета на другой счет (который, в определенной мере, похож на перенос рекомендации от одного члена Организации к другому члену Организации).</p>
</section>
<section id="process-manager-pattern">
<h6><a class="toc-backref" href="#id27" role="doc-backlink">Process Manager Pattern</a><a class="headerlink" href="#process-manager-pattern" title="Permalink to this heading">¶</a></h6>
<p>Второй способ описывает Vaughn Vernon в интервью &quot;<a class="reference external" href="https://www.infoq.com/articles/modeling-uncertainty-reactive-ddd/">Modeling Uncertainty with Reactive DDD</a>&quot; by Vaughn Vernon reviewed by Thomas Betts - путем применения <a class="reference external" href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html">Process Manager Pattern</a>.</p>
<p>Сюда же можно отнести <a class="reference external" href="https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf">SAGA pattern</a> и <a class="reference external" href="https://github.com/meirwah/awesome-workflow-engines">workflow engines</a>.</p>
</section>
<section id="pessimistic-offline-lock">
<h6><a class="toc-backref" href="#id28" role="doc-backlink">Pessimistic Offline Lock</a><a class="headerlink" href="#pessimistic-offline-lock" title="Permalink to this heading">¶</a></h6>
<p>Еще одним решением может быть <a class="reference external" href="https://martinfowler.com/eaaCatalog/pessimisticOfflineLock.html">пессимистическая блокировка</a> Агрегата <code class="docutils literal notranslate"><span class="pre">Endorser</span></code>.
Сценарий будет состоять из следующих этапов:</p>
<ul class="simple">
<li><p>блокировка Агрегата <code class="docutils literal notranslate"><span class="pre">Endorser</span></code>;</p></li>
<li><p>проверка возможности осуществления рекомендации;</p>
<ul>
<li><p>в случае неудачи - блокировка отпускается;</p></li>
<li><p>в случае успеха - порождается Доменное Событие;</p>
<ul>
<li><p>обработчик Доменного События вызывает <code class="docutils literal notranslate"><span class="pre">Specialist.ReceiveEndorsement(Endorser,</span> <span class="pre">ArtifactId,</span> <span class="pre">time.Time)</span> <span class="pre">error</span></code>;</p>
<ul>
<li><p>в случае успеха порождается Доменное Событие об успехе;</p>
<ul>
<li><p>обработчик Доменного События осуществит декрементирование счетчика доступных рекомендаций рекомендующего методом <code class="docutils literal notranslate"><span class="pre">Endorser.DecreaseAvailableEndorsementCount()</span></code> и отпустит блокировку;</p></li>
</ul>
</li>
<li><p>в случае неудачи порождается Доменное Событие о неудаче;</p>
<ul>
<li><p>обработчик Доменного События отпустит блокировку.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Блокировка не позволит рекомендующему осуществить другую рекомендацию, пока не завершится первая.</p>
</section>
<section id="id11">
<h6><a class="toc-backref" href="#id29" role="doc-backlink">Резервирование</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h6>
<p>Повысить параллелизм можно, если заменить блокировку на резервирование рекомендации, используя счетчик <code class="docutils literal notranslate"><span class="pre">Endorser.pendingEndorsementCount</span></code>, значение которого не должно превышать значение <code class="docutils literal notranslate"><span class="pre">Endorser.availableEndorsementCount</span></code>.
Сценарий будет состоять из следующих этапов:</p>
<ul class="simple">
<li><p>резервирование рекомендации инкрементированием счетчика <code class="docutils literal notranslate"><span class="pre">Endorser.pendingEndorsementCount</span></code>;</p></li>
<li><p>проверка возможности осуществления рекомендации;</p>
<ul>
<li><p>в случае неудачи - декрементирование счетчика <code class="docutils literal notranslate"><span class="pre">Endorser.pendingEndorsementCount</span></code>;</p></li>
<li><p>в случае успеха - порождается Доменное Событие;</p>
<ul>
<li><p>обработчик Доменного События вызывает <code class="docutils literal notranslate"><span class="pre">Specialist.ReceiveEndorsement(Endorser,</span> <span class="pre">ArtifactId,</span> <span class="pre">time.Time)</span> <span class="pre">error</span></code>;</p>
<ul>
<li><p>в случае успеха порождается Доменное Событие об успехе;</p>
<ul>
<li><p>обработчик Доменного События осуществит декрементирование счетчика доступных рекомендаций рекомендующего <code class="docutils literal notranslate"><span class="pre">Endorser.availableEndorsementCount</span></code> и отпустит резервирование декрементированием счетчика <code class="docutils literal notranslate"><span class="pre">Endorser.pendingEndorsementCount</span></code>;</p></li>
</ul>
</li>
<li><p>в случае неудачи порождается Доменное Событие о неудаче;</p>
<ul>
<li><p>обработчик Доменного События отпустит резервирование декрементированием счетчика <code class="docutils literal notranslate"><span class="pre">Endorser.pendingEndorsementCount</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Этот вариант выглядит наиболее простым, поэтому, на нем и остановимся.
Не исключено, что в будущем появятся альтернативные реализации с использованием описанных подходов.</p>
</section>
</section>
</section>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">Упрощенная реализация итоговой модели</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">grade_2</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;errors&quot;</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;time&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">MemberId</span><span class="w"> </span><span class="kt">uint64</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Grade</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ArtifactId</span><span class="w"> </span><span class="kt">uint64</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ArtifactDescription</span><span class="w"> </span><span class="kt">string</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ArtifactStatus</span><span class="w"> </span><span class="kt">uint8</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">CompetenceId</span><span class="w"> </span><span class="kt">uint64</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">CompetenceName</span><span class="w"> </span><span class="kt">string</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Weight</span><span class="w"> </span><span class="kt">uint8</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">LowerWeight</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nx">PeerWeight</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nx">HigherWeight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="w">    </span><span class="nx">Expert</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Candidate</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade1</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade2</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade3</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">WithoutGrade</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Grade</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="nx">Proposed</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nx">ArtifactStatus</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">Accepted</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="nx">ArtifactStatus</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Specialist</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">                       </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">grade</span><span class="w">                    </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">receivedEndorsements</span><span class="w">     </span><span class="p">[]</span><span class="nx">Endorsement</span><span class="w"></span>
<span class="w">    </span><span class="nx">assignments</span><span class="w">              </span><span class="p">[]</span><span class="nx">Assignment</span><span class="w"></span>
<span class="w">    </span><span class="nx">version</span><span class="w">                  </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">                </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">ReceiveEndorsement</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">,</span><span class="w"> </span><span class="nx">aId</span><span class="w"> </span><span class="nx">ArtifactId</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">GetGrade</span><span class="p">()</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;it is allowed to receive endorsements only from members with equal or higher grade&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">CanCompleteEndorsement</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;endorser is not able to complete endorsement&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">GetId</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;endorser can&#39;t endorse himself&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsements</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">IsEndorsedBy</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">GetId</span><span class="p">(),</span><span class="w"> </span><span class="nx">aId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;this artifact has already been endorsed by the recogniser&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsements</span><span class="p">,</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">GetId</span><span class="p">(),</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">GetGrade</span><span class="p">(),</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">GetVersion</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">aId</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">actualizeGrade</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">actualizeGrade</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">WithoutGrade</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getReceivedEndorsementCount</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Grade3</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Grade3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getReceivedEndorsementCount</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Grade2</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Grade2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getReceivedEndorsementCount</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Grade1</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Grade1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getReceivedEndorsementCount</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Candidate</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Candidate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getReceivedEndorsementCount</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">Expert</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">getReceivedEndorsementCount</span><span class="p">()</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">receivedEndorsements</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">GetSpecialistGrade</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">counter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">uint</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">GetWeight</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">counter</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">setGrade</span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="nx">Grade</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">assignments</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">assignments</span><span class="p">,</span><span class="w"> </span><span class="nx">Assignment</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">grade</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">g</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Specialist</span><span class="p">)</span><span class="w"> </span><span class="nx">IncreaseVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Endorsement</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserId</span><span class="w">        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserGrade</span><span class="w">     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">endorserVersion</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistId</span><span class="w">        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistGrade</span><span class="w">     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistVersion</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">artifactId</span><span class="w">          </span><span class="nx">ArtifactId</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">           </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">)</span><span class="w"> </span><span class="nx">IsEndorsedBy</span><span class="p">(</span><span class="nx">rId</span><span class="w"> </span><span class="nx">MemberId</span><span class="p">,</span><span class="w"> </span><span class="nx">aId</span><span class="w"> </span><span class="nx">ArtifactId</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">endorserId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">rId</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">artifactId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">aId</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">)</span><span class="w"> </span><span class="nx">GetSpecialistGrade</span><span class="p">()</span><span class="w"> </span><span class="nx">Grade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">specialistGrade</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">)</span><span class="w"> </span><span class="nx">GetWeight</span><span class="p">()</span><span class="w"> </span><span class="nx">Weight</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">endorserGrade</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">specialistGrade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">PeerWeight</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">endorserGrade</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">specialistGrade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">HigherWeight</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">LowerWeight</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Assignment</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistId</span><span class="w">       </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">specialistVersion</span><span class="w">  </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">assignedGrade</span><span class="w">      </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">          </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Endorser</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">                        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">grade</span><span class="w">                     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">pendingEndorsementCount</span><span class="w">   </span><span class="nx">EndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">version</span><span class="w">                   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">                 </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">GetId</span><span class="p">()</span><span class="w"> </span><span class="nx">MemberId</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">GetGrade</span><span class="p">()</span><span class="w"> </span><span class="nx">Grade</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">grade</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">GetVersion</span><span class="p">()</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">version</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">canReserveEndorsement</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">CanCompleteEndorsement</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">ReserveEndorsement</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">canReserveEndorsement</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;no endorsement can be reserved&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">ReleaseEndorsementReservation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">CompleteEndorsement</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;no endorsement is available&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;there is no endorsement reservation&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">IncreaseVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Artifact</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">            </span><span class="nx">ArtifactId</span><span class="w"></span>
<span class="w">    </span><span class="nx">status</span><span class="w">        </span><span class="nx">ArtifactStatus</span><span class="w"></span>
<span class="w">    </span><span class="nx">description</span><span class="w">   </span><span class="nx">ArtifactDescription</span><span class="w"></span>
<span class="w">    </span><span class="nx">competenceIds</span><span class="w"> </span><span class="p">[]</span><span class="nx">CompetenceId</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">     </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Competence</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">        </span><span class="nx">CompetenceId</span><span class="w"></span>
<span class="w">    </span><span class="nx">name</span><span class="w">      </span><span class="nx">CompetenceName</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Ссылка на полную модель:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/emacsway/grade/tree/main/grade/internal/domain">https://github.com/emacsway/grade/tree/main/grade/internal/domain</a></p></li>
</ul>
</section>
</section>
<section id="missing-chapter">
<h2><a class="toc-backref" href="#id31" role="doc-backlink">Missing chapter</a><a class="headerlink" href="#missing-chapter" title="Permalink to this heading">¶</a></h2>
<p>Проектом предусматривается поддержка <a class="reference external" href="https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/overview">Multitenancy</a>.
В свете этого, возникает потребность в гибком конфигурировании количества уровней классности для каждого <code class="docutils literal notranslate"><span class="pre">Tenant</span></code>, а также количества требуемых рекомендаций для достижения каждого уровня.
По этой причине, конструктор экземпляра Объекта-значения <code class="docutils literal notranslate"><span class="pre">Grade</span></code> должен создаваться Агрегатом <code class="docutils literal notranslate"><span class="pre">Tenant</span></code>.
Соответственно, фабричные методы Агрегатов <code class="docutils literal notranslate"><span class="pre">Endorser</span></code> и <code class="docutils literal notranslate"><span class="pre">Endorsement</span></code> должны переехать в Агрегат <code class="docutils literal notranslate"><span class="pre">Tenant</span></code>, чтобы иметь возможность принимать сконфигурированный экземпляр Объекта-значения <code class="docutils literal notranslate"><span class="pre">Grade</span></code>.</p>
<p>По мере роста гибкости бизнес-правил можно рассмотреть вариант применения &quot;<a class="reference external" href="https://martinfowler.com/bliki/RulesEngine.html">Rules Engine</a>&quot; (aka &quot;<a class="reference external" href="https://martinfowler.com/dslCatalog/productionRule.html">Production Rule System</a>&quot;), например, в виде &quot;<a class="reference external" href="https://github.com/hyperjumptech/grule-rule-engine">Grule-Rule-Engine</a>&quot; - Rule engine implementation in Golang.</p>
</section>
</section>



    
        
            <div class="section" style="text-align: right;">
                <p><a href="https://dckms.github.io/system-architecture/emacsway/it/ddd/grade/domain/aggregate-boundaries.html">Canonical URL</a></p>
            </div>
        
    

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="index.html" title="Previous document">Domain Layer</a>
        </li>
        <li>
          <a href="aggregate-encapsulation.html" title="Next document">Как сохранить Агрегат в БД не разрушая инкапсуляции?</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">System Architecture</a></h1>



<p class="blurb">Distributed Collaborative Knowledge Management System for System Architecture</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=dckms&repo=system-architecture&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Навигация</h3>
<p class="caption" role="heading"><span class="caption-text">Общее пространство:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../trunk/it/index.html">IT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trunk/soft-skills/index.html">Soft Skills</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../trunk/index.html">Общее пространство</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Авторские пространства:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Пространство Emacsway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ivan.ivanov/index.html">Пространство Ивана Иванова</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Приватное пространствo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../private/index.html">Приватное пространство</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Прочее:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../README.html">Как пользоваться</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://t.me/emacsway_log"><i class="fab fa-telegram" style="color:#54a9eb;"></i> Telegram</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../../trunk/it/index.html">IT</a></li>
  <li><a href="../../../../../trunk/it/ddd/index.html">DDD</a></li>
  <li><a href="../index.html">Golang DDD (CQRS / Event Sourcing) Reference Application &quot;Grade&quot;</a></li>
  <li><a href="index.html">Domain Layer</a></li><ul>
      <li>Previous: <a href="index.html" title="предыдущая глава">Domain Layer</a></li>
      <li>Next: <a href="aggregate-encapsulation.html" title="следующая глава">Как сохранить Агрегат в БД не разрушая инкапсуляции?</a></li></ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Быстрый поиск</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Искать" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    
    <div class="footer">
      &copy;2023, @dckms (<a href="https://dckms.github.io/system-architecture/LICENSE.txt" rel="nofollow">License</a>).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../../_sources/emacsway/it/ddd/grade/domain/aggregate-boundaries.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/dckms/system-architecture" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    

    
        <!-- Yandex.Metrika counter -->
        <script type="text/javascript" >
           (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
           m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
           (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

           ym(87033138, "init", {
                clickmap:true,
                trackLinks:true,
                accurateTrackBounce:true,
                webvisor:true,
                trackHash:true
           });
        </script>
        <noscript><div><img src="https://mc.yandex.ru/watch/87033138" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
        <!-- /Yandex.Metrika counter -->
    

  </body>
</html>