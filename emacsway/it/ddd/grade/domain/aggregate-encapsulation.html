
<!DOCTYPE html>

<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Как сохранить Агрегат в БД не разрушая инкапсуляции? &#8212; System Architecture</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" type="text/css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/translations.js"></script>
    <link rel="index" title="Алфавитный указатель" href="../../../../../genindex.html" />
    <link rel="search" title="Поиск" href="../../../../../search.html" />
    <link rel="next" title="Event Sourcing" href="event-sourcing.html" />
    <link rel="prev" title="Поиск границ Агрегатов" href="aggregate-boundaries.html" />
    
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />



    
        
            <link rel="canonical" href="https://dckms.github.io/system-architecture/emacsway/it/ddd/grade/domain/aggregate-encapsulation.html" />
        
    

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="aggregate-boundaries.html" title="Previous document">Поиск границ Агрегатов</a>
        </li>
        <li>
          <a href="event-sourcing.html" title="Next document">Event Sourcing</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
    
  <section id="emacsway-golang-encapsulation">
<span id="id1"></span><h1><a class="toc-backref" href="#id3" role="doc-backlink">Как сохранить Агрегат в БД не разрушая инкапсуляции?</a><a class="headerlink" href="#emacsway-golang-encapsulation" title="Permalink to this heading">¶</a></h1>
<p><em>Автор раздела: Ivan Zakrevsky</em></p>
<p>Инварианты лишены смысла своего существования в условиях дырявой, как решето, инкапсуляции.
Вопрос в том, как сохранить инкапсуляцию Агрегатов в Golang, когда нам требуется его внутреннее состояние для формирования SQL-запроса, или, наоборот, требуется установить состояние Агрегата в результате выполнения SQL-запроса.</p>
<nav class="contents" id="id2">
<p class="topic-title">Содержание</p>
<ul class="simple">
<li><p><a class="reference internal" href="#emacsway-golang-encapsulation" id="id3">Как сохранить Агрегат в БД не разрушая инкапсуляции?</a></p>
<ul>
<li><p><a class="reference internal" href="#memento-pattern" id="id4">Memento pattern</a></p></li>
<li><p><a class="reference internal" href="#walker" id="id5">Walker</a></p></li>
<li><p><a class="reference internal" href="#valuer-scanner" id="id6">Valuer &amp; Scanner</a></p></li>
<li><p><a class="reference internal" href="#reflection" id="id7">Reflection</a></p></li>
<li><p><a class="reference internal" href="#exporter" id="id8">Exporter</a></p>
<ul>
<li><p><a class="reference internal" href="#accepting-interface" id="id9">1. Accepting interface</a></p></li>
<li><p><a class="reference internal" href="#returning-structure" id="id10">2. Returning structure</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="memento-pattern">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Memento pattern</a><a class="headerlink" href="#memento-pattern" title="Permalink to this heading">¶</a></h2>
<p>Memento оказался близко, но не по назначению. Суть Memento в том, что он не должен раскрывать свое состояние никому, кроме своего создателя:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Preserving encapsulation boundaries. Memento avoids exposing information that only an originator should manage but that must be stored nevertheless outside the originator.
The pattern shields other objects from potentially complex Originator internals, thereby preserving encapsulation boundaries.</p></li>
</ol>
<p class="attribution">—&quot;Design Patterns: Elements of Reusable Object-Oriented Software&quot; by Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides</p>
</div></blockquote>
<p>Тем не менее, этот подход используется некоторыми авторитетными источниками, см. <a class="reference external" href="https://github.com/microsoftarchive/cqrs-journey/blob/6ffd9a8c8e865a9f8209552c52fa793fbd496d1f/source/Conference/Registration/SeatsAvailability.cs#L237">здесь</a> и <a class="reference external" href="https://github.com/microsoftarchive/cqrs-journey/blob/6ffd9a8c8e865a9f8209552c52fa793fbd496d1f/source/Infrastructure/Azure/Infrastructure.Azure/EventSourcing/AzureEventSourcedRepository.cs#L31">здесь</a>.</p>
</section>
<section id="walker">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Walker</a><a class="headerlink" href="#walker" title="Permalink to this heading">¶</a></h2>
<p>Walker представляет собою модификацию паттерна Visitor с целью сохранить инкапсуляцию Агрегатов. К числу недостатков паттерна паттерна Visitor относится:</p>
<blockquote>
<div><p>6. Breaking encapsulation. Visitor's approach assumes that the ConcreteElement interface is powerful enough to let visitors do their job.
As a result, the pattern often forces you to provide public operations that access an element's internal state, which may compromise its encapsulation.</p>
<p class="attribution">—&quot;Design Patterns: Elements of Reusable Object-Oriented Software&quot; by Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides</p>
</div></blockquote>
<p>Что будет создавать Walker в случае обхода иерархической структуры Агрегата с несколькими вложенными Сущностями?
Вероятно, это будет будет несколько SQL-запросов с параметрами, т.е. некий композитный объект, выраженный некой структурой данных.
Это лишает смысла использование Visitor, если можно сразу возвратить структуру данных, причем, абстрагированную от SQL.</p>
<p>Технически, можно сделать так:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Walkable</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Accept</span><span class="p">(</span><span class="nx">Walker</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Walker</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetField</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">WalkWalkable</span><span class="p">(</span><span class="nx">Walkable</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">WalkUint8</span><span class="p">(</span><span class="kt">uint8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">WalkUint64</span><span class="p">(</span><span class="kt">uint64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">WalkUint</span><span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">WalkTime</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorsement</span><span class="p">)</span><span class="w"> </span><span class="nx">Accept</span><span class="p">(</span><span class="nx">walker</span><span class="w"> </span><span class="nx">interfaces</span><span class="p">.</span><span class="nx">Walker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">walker</span><span class="p">.</span><span class="nx">SetField</span><span class="p">(</span><span class="s">&quot;endorserId&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">walker</span><span class="p">.</span><span class="nx">WalkWalkable</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">endorserId</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">walker</span><span class="p">.</span><span class="nx">SetField</span><span class="p">(</span><span class="s">&quot;endorserGrade&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">walker</span><span class="p">.</span><span class="nx">WalkWalkable</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">endorserGrade</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="nx">EndorserId</span><span class="p">)</span><span class="w"> </span><span class="nx">Accept</span><span class="p">(</span><span class="nx">walker</span><span class="w"> </span><span class="nx">interfaces</span><span class="p">.</span><span class="nx">Walker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">walker</span><span class="p">.</span><span class="nx">WalkUint64</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">Value</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Проблема в том, что на этапе создания SQL-запроса нам пока еще могут быть неизвестны первичные ключи Агрегатов, чтобы их можно было бы проставить в SQL-запросы их Сущностей.</p>
<p>Кроме того, осведомленность о способах образования SQL-запросов размазывается между Walkers и Repositories, что вызывает &quot;Разлет Дроби&quot; (Code Smell) в случае изменения существующего способа построения SQL (например, в случае изменения диалекта БД или в случае внедрения какого-либо QueryBuilder).
Walker начинает быть слишком осведомленным о деталях реализации Repository.</p>
<p>В целях достижения DRY возникает целесообразность возложить на Walker генерирование только части SQL, и освободить его от осведомленности знания таблиц в БД, что будет разрывать обязанность за построение SQL на несколько объектов и подрывать Cohesion.</p>
</section>
<section id="valuer-scanner">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Valuer &amp; Scanner</a><a class="headerlink" href="#valuer-scanner" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://pkg.go.dev/database/sql/driver#Valuer">Valuer</a></p></li>
<li><p><a class="reference external" href="https://pkg.go.dev/database/sql#Scanner">Scanner</a></p></li>
</ul>
<p>Интерфейс Scanner открывает дверь к изменяемости ValueObject, что противоречит основной его сути.
А так же открывает брешь в инкапсуляции Агрегата.
Справедливости ради, стоит отметить, что можно его реализовать таким образом, чтобы он был только однократно мутируемым, предварительно проверяя, не установлено ли уже значение.</p>
<p>Но есть еще один момент - метод <code class="docutils literal notranslate"><span class="pre">Scan(src</span> <span class="pre">any)</span> <span class="pre">error</span></code> вызывается у конкретного типа, что препятствует использованию паттерна, известного как <a class="reference external" href="https://martinfowler.com/eaaCatalog/specialCase.html">Special Case</a> или <a class="reference external" href="https://refactoring.com/catalog/introduceSpecialCase.html">Null Object</a>.
Кроме того, в некоторых случаях может потребоваться преобразовать неизменяемые исторические данные для новой версии модели.
Вопрос затрагивался в разделе &quot;4. Validating historical data&quot; статьи &quot;<a class="reference external" href="https://enterprisecraftsmanship.com/posts/always-valid-domain-model/">Always-Valid Domain Model</a>&quot; by Vladimir Khorikov и в разделе &quot;6. The use of ORMs within and outside of the always-valid boundary&quot; статьи &quot;<a class="reference external" href="https://enterprisecraftsmanship.com/posts/database-always-valid-domain-model/">Database and Always-Valid Domain Model</a>&quot; by Vladimir Khorikov.</p>
<p>С другой стороны, Valuer может возвращать только примитивные типы, а значит, он не пригоден для экспорта иерархической структуры состояния Агрегата:</p>
<blockquote>
<div><p>It is either nil, a type handled by a database driver's NamedValueChecker interface, or an instance of one of these types:</p>
<ul class="simple">
<li><p>int64</p></li>
<li><p>float64</p></li>
<li><p>bool</p></li>
<li><p>[]byte</p></li>
<li><p>string</p></li>
<li><p>time.Time</p></li>
</ul>
<p class="attribution">—<a class="reference external" href="https://pkg.go.dev/database/sql/driver#Value">Источник</a></p>
</div></blockquote>
</section>
<section id="reflection">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Reflection</a><a class="headerlink" href="#reflection" title="Permalink to this heading">¶</a></h2>
<p>В документации <a class="reference external" href="https://pkg.go.dev/reflect#Value.FieldByName">отсутствуют</a> какие-либо упоминания об ограничении доступа к защищенным атрибутам структуры данных посредством рефлекции.</p>
<p>Может быть через рефлексию и заработало бы - я не пробовал.
Но использовать рефлексию в production для таких целей как-то не сильно хочется, в т.ч. и по соображениям производительности.
К тому же этот метод является, по сути, еще одним способом пробить брешь в инкапсуляции.</p>
</section>
<section id="exporter">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Exporter</a><a class="headerlink" href="#exporter" title="Permalink to this heading">¶</a></h2>
<section id="accepting-interface">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">1. Accepting interface</a><a class="headerlink" href="#accepting-interface" title="Permalink to this heading">¶</a></h3>
<p>Ссылки по теме:</p>
<ul class="simple">
<li><p>&quot;<a class="reference external" href="https://www.infoworld.com/article/2072302/more-on-getters-and-setters.html">More on getters and setters</a>&quot; by Allen Holub</p></li>
<li><p>&quot;<a class="reference external" href="https://stackoverflow.com/questions/24921227/save-and-load-objects-without-breaking-encapsulation">Save and load objects without breaking encapsulation</a>&quot; at Stackoverflow</p></li>
</ul>
<p>Идею можно посмотреть на примере:</p>
<div class="literal-block-wrapper docutils container" id="emacsway-code-exporter-example-1">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://www.infoworld.com/article/2072302/more-on-getters-and-setters.html">Example by Allen Holub</a></span><a class="headerlink" href="#emacsway-code-exporter-example-1" title="Постоянная ссылка на код">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Locale</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Employee</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="n">Name</span><span class="w">        </span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="n">EmployeeId</span><span class="w">  </span><span class="n">id</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="n">Money</span><span class="w">       </span><span class="n">salary</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Exporter</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="nf">addName</span><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w">   </span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="kt">void</span><span class="w"> </span><span class="nf">addID</span><span class="w">      </span><span class="p">(</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="kt">void</span><span class="w"> </span><span class="nf">addSalary</span><span class="w">  </span><span class="p">(</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Importer</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w">   </span><span class="n">String</span><span class="w"> </span><span class="nf">provideName</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="n">String</span><span class="w"> </span><span class="nf">provideID</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="n">String</span><span class="w"> </span><span class="nf">provideSalary</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="kt">void</span><span class="w">   </span><span class="nf">open</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="kt">void</span><span class="w">   </span><span class="nf">close</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="nf">Employee</span><span class="p">(</span><span class="w"> </span><span class="n">Importer</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w">   </span><span class="n">builder</span><span class="p">.</span><span class="na">open</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Name</span><span class="w">      </span><span class="p">(</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">provideName</span><span class="p">()</span><span class="w">     </span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">EmployeeId</span><span class="p">(</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">provideID</span><span class="p">()</span><span class="w">       </span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="na">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Money</span><span class="w">     </span><span class="p">(</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">provideSalary</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                       </span><span class="k">new</span><span class="w"> </span><span class="n">Locale</span><span class="p">(</span><span class="s">&quot;en&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;US&quot;</span><span class="p">)</span><span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="n">builder</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="w"> </span><span class="n">Exporter</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w">   </span><span class="n">builder</span><span class="p">.</span><span class="na">addName</span><span class="w">  </span><span class="p">(</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w">   </span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="n">builder</span><span class="p">.</span><span class="na">addID</span><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">id</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w">     </span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="n">builder</span><span class="p">.</span><span class="na">addSalary</span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="c1">//...</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Пример реализации:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">grade_1</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;time&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Exporter</span><span class="p">[</span><span class="nx">T</span><span class="w"> </span><span class="kt">any</span><span class="p">]</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetState</span><span class="p">(</span><span class="nx">T</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Exportable</span><span class="p">[</span><span class="nx">T</span><span class="w"> </span><span class="kt">any</span><span class="p">]</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">ExportTo</span><span class="p">(</span><span class="nx">Exporter</span><span class="p">[</span><span class="nx">T</span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="p">)</span><span class="w"> </span><span class="nx">Export</span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="nx">Exporter</span><span class="p">[</span><span class="kt">uint</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">SetState</span><span class="p">(</span><span class="nb">uint</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">MemberId</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Grade</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">EndorserExporterSetter</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetId</span><span class="p">(</span><span class="nx">MemberId</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetGrade</span><span class="p">(</span><span class="nx">Grade</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetAvailableEndorsementCount</span><span class="p">(</span><span class="nx">EndorsementCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetPendingEndorsementCount</span><span class="p">(</span><span class="nx">EndorsementCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetVersion</span><span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">SetCreatedAt</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">UintExporter</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">UintExporter</span><span class="p">)</span><span class="w"> </span><span class="nx">SetState</span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="kt">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="nx">e</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">UintExporter</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Endorser</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">                        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">grade</span><span class="w">                     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">pendingEndorsementCount</span><span class="w">   </span><span class="nx">EndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">version</span><span class="w">                   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">                 </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">Export</span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="nx">EndorserExporterSetter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">SetId</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">SetGrade</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">grade</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">SetAvailableEndorsementCount</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">SetPendingEndorsementCount</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">SetVersion</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">SetCreatedAt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">EndorserExporter</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Id</span><span class="w">                        </span><span class="nx">UintExporter</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade</span><span class="w">                     </span><span class="nx">UintExporter</span><span class="w"></span>
<span class="w">    </span><span class="nx">AvailableEndorsementCount</span><span class="w"> </span><span class="nx">UintExporter</span><span class="w"></span>
<span class="w">    </span><span class="nx">PendingEndorsementCount</span><span class="w">   </span><span class="nx">UintExporter</span><span class="w"></span>
<span class="w">    </span><span class="nx">Version</span><span class="w">                   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">CreatedAt</span><span class="w">                 </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="o">*</span><span class="nx">EndorserExporter</span><span class="p">)</span><span class="w"> </span><span class="nx">SetId</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="nx">MemberId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">val</span><span class="p">.</span><span class="nx">Export</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ex</span><span class="p">.</span><span class="nx">Id</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="o">*</span><span class="nx">EndorserExporter</span><span class="p">)</span><span class="w"> </span><span class="nx">SetGrade</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="nx">Grade</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">val</span><span class="p">.</span><span class="nx">Export</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ex</span><span class="p">.</span><span class="nx">Grade</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="o">*</span><span class="nx">EndorserExporter</span><span class="p">)</span><span class="w"> </span><span class="nx">SetAvailableEndorsementCount</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">val</span><span class="p">.</span><span class="nx">Export</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ex</span><span class="p">.</span><span class="nx">AvailableEndorsementCount</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="o">*</span><span class="nx">EndorserExporter</span><span class="p">)</span><span class="w"> </span><span class="nx">SetPendingEndorsementCount</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">val</span><span class="p">.</span><span class="nx">Export</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ex</span><span class="p">.</span><span class="nx">PendingEndorsementCount</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="o">*</span><span class="nx">EndorserExporter</span><span class="p">)</span><span class="w"> </span><span class="nx">SetVersion</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="kt">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">Version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">val</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="w"> </span><span class="o">*</span><span class="nx">EndorserExporter</span><span class="p">)</span><span class="w"> </span><span class="nx">SetCreatedAt</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">ex</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">val</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Или на более лаконичном примере:</p>
<div class="literal-block-wrapper docutils container" id="emacsway-code-exporter-example-2">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://stackoverflow.com/questions/24921227/save-and-load-objects-without-breaking-encapsulation">Example from Stackoverflow</a></span><a class="headerlink" href="#emacsway-code-exporter-example-2" title="Постоянная ссылка на код">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="kd">interface</span> <span class="nc">PersonImporter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getAge</span><span class="p">();</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getId</span><span class="p">();</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="kd">interface</span> <span class="nc">PersonExporter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setDetails</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="kd">class</span> <span class="nc">Person</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="nf">Person</span><span class="p">(</span><span class="n">PersonImporter</span><span class="w"> </span><span class="n">importer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importer</span><span class="p">.</span><span class="na">getAge</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importer</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="n">PersonExporter</span><span class="w"> </span><span class="n">exporter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">exporter</span><span class="p">.</span><span class="na">setDetails</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Замечательный вариант, но проблема в том, что он использует интерефейсы, и это получается слишком многословно - требуется декларировать сам тип (структуру), интерфейс, сеттеры.
Вряд ли кто-то будет этим заниматься, когда можно просто обязать Агрегат вернуть простую структуру.</p>
<blockquote>
<div><p>💬️ &quot;Цель архитектуры программного обеспечения — уменьшить человеческие трудозатраты на создание и сопровождение системы.</p>
<p>The goal of software architecture is to minimize the human resources required to build and maintain the required system.&quot;</p>
<p class="attribution">—&quot;Clean Architecture: A Craftsman's Guide to Software Structure and Design&quot; by Robert C. Martin, перевод ООО Издательство &quot;Питер&quot;</p>
</div></blockquote>
<p><a class="reference internal" href="#emacsway-code-exporter-example-2"><span class="std std-ref">Второй</span></a> из приведенных примеров содержит пакетированный сеттер, что делает его несколько менее многословным.
Этот вариант уступает первому варианту тем, что в случае одноименного метода <code class="docutils literal notranslate"><span class="pre">setDetails</span></code> нельзя обойти одним экспортером сразу несколько вложенных объектов, например, агрегат и его композитный первичный ключ, что может быть удобным для составления списка параметров SQL-запроса.
В таком случае придется жертвовать консистентностью именования, что лишает второй вариант превосходств перед первым вариантом.
Также второй вариант обладает несколько большей хрупкостью при добавлении новых полей, либо их удалении.</p>
<p>Немного смущает смешивание парадигм FP и OOP для ValueObject.
Хотя ValueObject и остается неизменяемым, но сам факт того, что функционально чистый объект вызывает мутирующие методы другого объекта, вызывает небольшое смущение.
Возникает вопрос - почему функционально чистый объект не может просто взять и вернуть другой функционально чистый объект?
Если бы Golang поддерживать Generics для методов, тогда могло бы получиться что-то похожее на <code class="docutils literal notranslate"><span class="pre">Endorser.Export[T](exporterFactory</span> <span class="pre">function(attr1,</span> <span class="pre">attr2,</span> <span class="pre">attr3)</span> <span class="pre">T)</span> <span class="pre">T</span></code>.
Однако, если продолжить развивать эту мысль, то мы обнаружим, что таким образом пытаемся решить проблему обхода инкапсуляции, которая вызвана именно применением OOP.</p>
<p>Как говорил Michael Feathers:</p>
<blockquote>
<div><p>💬️ &quot;OO makes code understandable by encapsulating moving parts.
FP makes code understandable by minimizing moving parts.&quot;
— <a class="reference external" href="https://twitter.com/mfeathers/status/29581296216">Michael Feathers</a></p>
</div></blockquote>
<p>Использование такого подхода в тестовых кейсах делает их несколько более многословными.</p>
<p>Можно было бы сказать, что тестировать нужно по принципам <a class="reference internal" href="../../../tdd/tdd.html#emacsway-tdd-black-box"><span class="std std-ref">черного ящика</span></a>, т.е. только внешнее поведение.
Совершенно верно, но только нам требуется не только внешнее поведение, но и достоверность сохранения введенной в конструктор Агрегата информации в БД.</p>
<blockquote>
<div><p>💬️ &quot;Давно известно, что простота тестирования является характерным признаком хорошей архитектуры.
Шаблон «Скромный объект» — хороший пример, потому что раздел между легко и тяжело тестируемыми частями часто совпадает с архитектурными границами.
Раздел между Презентаторами и Представлениями — одна из таких границ, но существует много других.</p>
<p>It has long been known that testability is an attribute of good architectures.
The Humble Object pattern is a good example, because the separation of the behaviors into testable and non-testable parts often defines an architectural boundary.
The Presenter/View boundary is one of these boundaries, but there are many others.&quot;</p>
<p class="attribution">—&quot;Clean Architecture: A Craftsman's Guide to Software Structure and Design&quot; by Robert C. Martin, перевод ООО Издательство &quot;Питер&quot;</p>
</div></blockquote>
</section>
<section id="returning-structure">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">2. Returning structure</a><a class="headerlink" href="#returning-structure" title="Permalink to this heading">¶</a></h3>
<p>Возникает целесообразность облегчить метод экспортирования, придав ему сигнатуру <code class="docutils literal notranslate"><span class="pre">Endorser.Export()</span> <span class="pre">EndorserState</span></code> вместо <code class="docutils literal notranslate"><span class="pre">Endorser.ExportTo(ex</span> <span class="pre">EndorserExporter)</span></code>.
Получится что-то типа DTO с тем лишь отличием, что он пересекает не сетевые границы, а границы инкапсуляции Агрегата.
В Golang этот вариант выглядит чуть более привлекательным, хотя и менее OOP, но зато не контрастирует с FP принципами Value Object.</p>
<p>О таком же принципе этом писал Robert C. Martin:</p>
<blockquote>
<div><p>💬️ &quot;Презентаторы являются разновидностью шаблона проектирования «Скромный объект» (Humble Object), помогающего выявлять и защищать архитектурные границы.</p>
<p>Presenters are a form of the Humble Object pattern, which helps us identify and protect architectural boundaries.&quot;</p>
<p>💬️ &quot;Обычно через границы данные передаются в виде простых структур.
При желании можно использовать простейшие структуры или объекты передачи данных (Data Transfer Objects; DTO).
Данные можно также передавать в вызовы функций через аргументы.
Или упаковывать их в ассоциативные массивы или объекты.
Важно, чтобы через границы передавались простые, изолированные структуры данных.
Не нужно хитрить и передавать объекты сущностей или записи из базы данных.
Структуры данных не должны нарушать правило зависимостей.</p>
<p>Например, многие фреймворки для работы с базами данных возвращают ответы на запросы в удобном формате.
Их можно назвать «представлением записей».
Такие представления записей не должны передаваться через границы внутрь.
Это нарушает правило зависимостей, потому что заставляет внутренний круг знать что-то о внешнем круге.
Итак, при передаче через границу данные всегда должны принимать форму, наиболее удобную для внутреннего круга.</p>
<p>Typically the data that crosses the boundaries consists of <strong>simple data structures</strong>.
You can use <strong>basic structs or simple data transfer objects</strong> if you like.
Or the data can simply be arguments in function calls.
Or you can pack it into a hashmap, or construct it into an object.
The important thing is that isolated, <strong>simple data structures</strong> are passed across the boundaries.
We don't want to cheat and pass Entity objects or database rows.
We don't want the data structures to have any kind of dependency that violates the Dependency Rule.</p>
<p>For example, many database frameworks return a convenient data format in response to a query.
We might call this a &quot;row structure.&quot;
We don't want to pass that row structure inward across a boundary.
Doing so would violate the Dependency Rule because it would force an inner circle to know something about an outer circle.</p>
<p>Thus, when we pass data across a boundary, it is always in the form that is most convenient for the inner circle.&quot;</p>
<p>💬️ &quot;Он также переносит данные из базы данных Database в память сущностей Entities через интерфейс DataAccessInterface.
По завершении UseCaseInteractor забирает данные из сущностей Entities и конструирует из них другой простой Java-объект OutputData.
Затем объект OutputData передается через интерфейс OutputBoundary презентатору Presenter.</p>
<p>It also uses the DataAccessInterface to bring the data used by those Entities into memory from the Database.
Upon completion, the UseCaseInteractor gathers data from the Entities and constructs the OutputData as another <strong>plain old Java object</strong>.
The OutputData is then passed through the OutputBoundary interface to the Presenter.&quot;</p>
<p class="attribution">—&quot;Clean Architecture: A Craftsman's Guide to Software Structure and Design&quot; by Robert C. Martin, перевод ООО Издательство &quot;Питер&quot;</p>
</div></blockquote>
<p>Этот подход демонстрируется в <a class="reference external" href="https://github.com/EventStore/training-advanced-go/blob/9cc2b5a4f3484dc643757c88480c4b6e371149fd/domain/doctorday/day.go#L225">Golang DDD ES/CQRS Reference Application</a> от контрибьюторов EventStore.</p>
<p>И такой же подход демонстрирует Nick Tune в <a class="reference external" href="https://github.com/elbandit/PPPDDD/blob/4d9d864fa6d9dfc0bad323ae21e949be1808b460/21%20-%20Repositories/DDDPPP.Chap21.EFExample/DDDPPP.Chap21.EFExample.Application/Model/Auction/Auction.cs#L48">демонстрационном коде</a> к своей книге.
Причем, применяет он его даже <a class="reference external" href="https://github.com/elbandit/PPPDDD/blob/4d9d864fa6d9dfc0bad323ae21e949be1808b460/21%20-%20Repositories/DDDPPP.Chap21.EFExample/DDDPPP.Chap21.EFExample.Application/Model/Auction/Money.cs#L58">для Value Object</a>.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">grade_2</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;time&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Exportable</span><span class="p">[</span><span class="nx">T</span><span class="w"> </span><span class="kt">any</span><span class="p">]</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Export</span><span class="p">()</span><span class="w"> </span><span class="nx">T</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="p">)</span><span class="w"> </span><span class="nx">Export</span><span class="p">()</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">uint</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">MemberId</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Grade</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="w"> </span><span class="nx">ExportableUint</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">EndorserState</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Id</span><span class="w">                        </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">Grade</span><span class="w">                     </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">AvailableEndorsementCount</span><span class="w"> </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">PendingEndorsementCount</span><span class="w">   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">Version</span><span class="w">                   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">CreatedAt</span><span class="w">                 </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Endorser</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">id</span><span class="w">                        </span><span class="nx">MemberId</span><span class="w"></span>
<span class="w">    </span><span class="nx">grade</span><span class="w">                     </span><span class="nx">Grade</span><span class="w"></span>
<span class="w">    </span><span class="nx">availableEndorsementCount</span><span class="w"> </span><span class="nx">EndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">pendingEndorsementCount</span><span class="w">   </span><span class="nx">EndorsementCount</span><span class="w"></span>
<span class="w">    </span><span class="nx">version</span><span class="w">                   </span><span class="kt">uint</span><span class="w"></span>
<span class="w">    </span><span class="nx">createdAt</span><span class="w">                 </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">Endorser</span><span class="p">)</span><span class="w"> </span><span class="nx">Export</span><span class="p">()</span><span class="w"> </span><span class="nx">EndorserState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">EndorserState</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">Export</span><span class="p">(),</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">grade</span><span class="p">.</span><span class="nx">Export</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">availableEndorsementCount</span><span class="p">.</span><span class="nx">Export</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">pendingEndorsementCount</span><span class="p">.</span><span class="nx">Export</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Недостатком такого решения, который я успел обнаружить, является то, что клиент не имеет возможности контролировать структуру экспортируемого объекта, в отличии от варианта с интерфейсом.
Это затрудняет создание обобщенных классов, например, <a class="reference external" href="https://martinfowler.com/eaaCatalog/identityField.html">обобщенного композитного первичного ключа</a>.
В результате плодятся промежуточные структуры, которые затем нужно преобразовывать к нужному виду.</p>
<p>Знание о возвращаемом типе подталкивает к применению generics там, где этого несложно избежать.</p>
<p>Возвращаемая структура и ее типизация является избыточным знанием, которое может препятствовать обобщению (абстрагированию) клиента этого метода, например, препятствовать выделению абстрактного класса паттерна Repository.
Гораздо удобней в таком случае был бы массив/срез объектов с типом <a class="reference external" href="https://pkg.go.dev/database/sql/driver#Value">driver.Value</a>.
Это еще один аргумент в пользу первого варианта с отдельными сеттерами для каждого атрибута Агрегата.</p>
<p>Попробовав оба варианта, я остановился, все-таки, на первом, каноническом, даже несмотря на его многословность.</p>
</section>
</section>
</section>



    
        
            <div class="section" style="text-align: right;">
                <p><a href="https://dckms.github.io/system-architecture/emacsway/it/ddd/grade/domain/aggregate-encapsulation.html">Canonical URL</a></p>
            </div>
        
    

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="aggregate-boundaries.html" title="Previous document">Поиск границ Агрегатов</a>
        </li>
        <li>
          <a href="event-sourcing.html" title="Next document">Event Sourcing</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">System Architecture</a></h1>



<p class="blurb">Distributed Collaborative Knowledge Management System for System Architecture</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=dckms&repo=system-architecture&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Навигация</h3>
<p class="caption" role="heading"><span class="caption-text">Общее пространство:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../trunk/it/index.html">IT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trunk/soft-skills/index.html">Soft Skills</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../trunk/index.html">Общее пространство</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Авторские пространства:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Пространство Emacsway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ivan.ivanov/index.html">Пространство Ивана Иванова</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Приватное пространствo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../private/index.html">Приватное пространство</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Прочее:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../README.html">Как пользоваться</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://t.me/emacsway_log"><i class="fab fa-telegram" style="color:#54a9eb;"></i> Telegram</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../../trunk/it/index.html">IT</a></li>
  <li><a href="../../../../../trunk/it/ddd/index.html">DDD</a></li>
  <li><a href="../index.html">Golang DDD (CQRS / Event Sourcing) Reference Application &quot;Grade&quot;</a></li>
  <li><a href="index.html">Domain Layer</a></li><ul>
      <li>Previous: <a href="aggregate-boundaries.html" title="предыдущая глава">Поиск границ Агрегатов</a></li>
      <li>Next: <a href="event-sourcing.html" title="следующая глава">Event Sourcing</a></li></ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Быстрый поиск</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Искать" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    
    <div class="footer">
      &copy;2023, @dckms (<a href="https://dckms.github.io/system-architecture/LICENSE.txt" rel="nofollow">License</a>).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../../_sources/emacsway/it/ddd/grade/domain/aggregate-encapsulation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/dckms/system-architecture" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    

    
        <!-- Yandex.Metrika counter -->
        <script type="text/javascript" >
           (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
           m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
           (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

           ym(87033138, "init", {
                clickmap:true,
                trackLinks:true,
                accurateTrackBounce:true,
                webvisor:true,
                trackHash:true
           });
        </script>
        <noscript><div><img src="https://mc.yandex.ru/watch/87033138" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
        <!-- /Yandex.Metrika counter -->
    

  </body>
</html>